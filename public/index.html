<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Web Client Prototype</title>
    <!-- Tailwind CSS para estilização rápida e profissional -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Paho MQTT Client via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
        type="text/javascript"></script>
    <style>
        /* Animação suave para novas mensagens */
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <div class="container mx-auto p-4 max-w-4xl">

        <!-- Header -->
        <header class="mb-6 flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
            <div>
                <h1 class="text-2xl font-bold text-blue-600">MQTT Web Client</h1>
                <p class="text-sm text-gray-500">Protótipo de Comunicação via WebSocket</p>
            </div>
            <div id="status-indicator"
                class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-semibold">
                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                Desconectado
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Coluna da Esquerda: Configurações e Ações -->
            <div class="md:col-span-1 space-y-6">

                <!-- Card de Conexão -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="font-bold text-gray-700 mb-4 border-b pb-2">Configuração do Broker</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Host</label>
                            <input type="text" id="host" value="localhost"
                                class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Porta (WebSocket)</label>
                            <input type="number" id="port" value="9001"
                                class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400 outline-none transition">
                        </div>
                        <button id="btn-connect" onclick="toggleConnection()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Conectar
                        </button>
                    </div>
                </div>

                <!-- Card de Publicação -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 opacity-50 pointer-events-none transition"
                    id="publish-card">
                    <h2 class="font-bold text-gray-700 mb-4 border-b pb-2">Publicar Mensagem</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Tópico</label>
                            <input type="text" id="pub-topic" placeholder="ex: sensores/temp"
                                class="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Mensagem</label>
                            <textarea id="pub-payload" placeholder="Conteúdo da mensagem..."
                                class="w-full p-2 border rounded focus:ring-2 focus:ring-green-400 outline-none h-20 resize-none"></textarea>
                        </div>
                        <button onclick="publishMessage()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Enviar
                        </button>
                    </div>
                </div>

                <!-- Card de Assinatura -->
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 opacity-50 pointer-events-none transition"
                    id="subscribe-card">
                    <h2 class="font-bold text-gray-700 mb-4 border-b pb-2">Assinar Tópico</h2>
                    <div class="flex gap-2">
                        <input type="text" id="sub-topic" placeholder="ex: sensores/#"
                            class="w-full p-2 border rounded focus:ring-2 focus:ring-purple-400 outline-none">
                        <button onclick="subscribeTopic()"
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 rounded transition">
                            +
                        </button>
                    </div>
                    <div id="subs-list" class="mt-3 flex flex-wrap gap-2">
                        <!-- Badges de tópicos assinados aparecerão aqui -->
                    </div>
                </div>

            </div>

            <!-- Coluna da Direita: Console de Mensagens -->
            <div class="md:col-span-2">
                <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="font-bold text-gray-700">Console de Mensagens</h2>
                        <button onclick="clearConsole()"
                            class="text-xs text-gray-500 hover:text-red-500">Limpar</button>
                    </div>

                    <div id="messages-container"
                        class="flex-1 overflow-y-auto bg-gray-50 rounded p-4 font-mono text-sm space-y-2 h-[500px]">
                        <p class="text-gray-400 italic text-center mt-20">Aguardando conexão...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Variáveis Globais
        let client = null;
        let isConnected = false;

        // Elementos do DOM
        const btnConnect = document.getElementById('btn-connect');
        const statusIndicator = document.getElementById('status-indicator');
        const publishCard = document.getElementById('publish-card');
        const subscribeCard = document.getElementById('subscribe-card');
        const messagesContainer = document.getElementById('messages-container');
        const subsList = document.getElementById('subs-list');

        // Função para Alternar Conexão
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        // Conectar ao Broker
        function connect() {
            const host = document.getElementById('host').value;
            const port = Number(document.getElementById('port').value);
            const clientId = "clientID-" + parseInt(Math.random() * 100);

            // Cria o cliente Paho
            client = new Paho.MQTT.Client(host, port, clientId);

            // Define callbacks
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure,
                // Importante para funcionar em navegadores modernos se o broker não tiver SSL
                // Se usar SSL (wss), mude useSSL para true
                useSSL: false
            };

            logSystem("Tentando conectar a " + host + ":" + port + "...");
            client.connect(options);
        }

        // Desconectar
        function disconnect() {
            if (client) {
                client.disconnect();
                logSystem("Desconectado pelo usuário.");
                updateUI(false);
            }
        }

        // Callback: Sucesso na conexão
        function onConnect() {
            logSystem("Conectado com sucesso!");
            updateUI(true);
        }

        // Callback: Falha na conexão
        function onFailure(message) {
            logSystem("Falha na conexão: " + message.errorMessage, "error");
            updateUI(false);
        }

        // Callback: Conexão perdida
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                logSystem("Conexão perdida: " + responseObject.errorMessage, "error");
            }
            updateUI(false);
        }

        // Callback: Mensagem Recebida
        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            logMessage(topic, payload);
        }

        // Publicar Mensagem
        function publishMessage() {
            const topic = document.getElementById('pub-topic').value;
            const payload = document.getElementById('pub-payload').value;

            if (topic === "" || payload === "") {
                alert("Preencha o tópico e a mensagem.");
                return;
            }

            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            client.send(message);

            // Log local visual apenas para confirmação (opcional)
            logMessage(topic, payload, true);
        }

        // Assinar Tópico
        function subscribeTopic() {
            const topic = document.getElementById('sub-topic').value;
            if (topic === "") return;

            client.subscribe(topic);
            logSystem("Assinado no tópico: " + topic);

            // Adicionar badge visual
            const badge = document.createElement('span');
            badge.className = "bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs border border-purple-200";
            badge.innerText = topic;
            subsList.appendChild(badge);

            document.getElementById('sub-topic').value = '';
        }

        // Atualizar UI baseado no estado
        function updateUI(connected) {
            isConnected = connected;

            if (connected) {
                btnConnect.innerText = "Desconectar";
                btnConnect.classList.replace("bg-blue-600", "bg-red-600");
                btnConnect.classList.replace("hover:bg-blue-700", "hover:bg-red-700");

                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Conectado';
                statusIndicator.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-green-100 text-green-700 text-sm font-semibold";

                publishCard.classList.remove("opacity-50", "pointer-events-none");
                subscribeCard.classList.remove("opacity-50", "pointer-events-none");
            } else {
                btnConnect.innerText = "Conectar";
                btnConnect.classList.replace("bg-red-600", "bg-blue-600");
                btnConnect.classList.replace("hover:bg-red-700", "hover:bg-blue-700");

                statusIndicator.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Desconectado';
                statusIndicator.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-red-100 text-red-600 text-sm font-semibold";

                publishCard.classList.add("opacity-50", "pointer-events-none");
                subscribeCard.classList.add("opacity-50", "pointer-events-none");
                subsList.innerHTML = ''; // Limpa assinaturas visuais
            }
        }

        // Função de Log no Console Visual
        function logMessage(topic, payload, isSent = false) {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            const directionIcon = isSent ? '⬆️' : '⬇️';
            const colorClass = isSent ? 'text-green-600' : 'text-blue-600';

            div.className = "message-enter p-2 border-l-4 bg-white shadow-sm " + (isSent ? "border-green-400" : "border-blue-400");
            div.innerHTML = `
                <div class="flex justify-between text-xs text-gray-400 mb-1">
                    <span>${directionIcon} ${topic}</span>
                    <span>${time}</span>
                </div>
                <div class="${colorClass} font-semibold break-all">${payload}</div>
            `;

            // Remove mensagem de "aguardando" se existir
            if (messagesContainer.querySelector('p')) messagesContainer.innerHTML = '';

            messagesContainer.prepend(div);
        }

        function logSystem(msg, type = "info") {
            const div = document.createElement('div');
            const color = type === "error" ? "text-red-500" : "text-gray-500";
            div.className = `text-xs italic ${color} text-center my-2`;
            div.innerText = `[SISTEMA] ${msg}`;

            if (messagesContainer.querySelector('p')) messagesContainer.innerHTML = '';
            messagesContainer.prepend(div);
        }

        function clearConsole() {
            messagesContainer.innerHTML = '<p class="text-gray-400 italic text-center mt-20">Console limpo.</p>';
        }
    </script>
</body>

</html>